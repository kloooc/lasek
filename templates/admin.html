<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Panel Admina</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/css/styles.css') }}">
    <link href='https://cdn.jsdelivr.net/npm/boxicons@2.0.5/css/boxicons.min.css' rel='stylesheet'>
    <!-- Dodaj Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Dodaj jQuery i Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>
</head>
<body>
    <header class="l-header" id="header">
        <nav class="nav bd-container">
            <a href="{{ url_for('home') }}" class="nav__logo"><h1>Kociołek</h1></a>
            <div class="nav__menu" id="nav-menu">
                <ul class="nav__list">
                    <li class="nav__item"><a href="{{ url_for('home') }}#home" class="nav__link">Home</a></li>
                    <li class="nav__item"><a href="{{ url_for('home') }}#about" class="nav__link">About</a></li>
                    <li class="nav__item"><a href="{{ url_for('admin') }}" class="nav__link active-link">Panel Admina</a></li>
                    <li class="nav__item"><a href="{{ url_for('logout') }}" class="nav__link">Wyloguj</a></li>
                </ul>
            </div>
            <div class="nav__toggle" id="nav-toggle">
                <i class='bx bx-menu'></i>
            </div>
        </nav>
    </header>

    <main class="l-main">
        <section class="section bd-container">
            <!-- Sekcja użytkowników -->
<div class="container">
    <h2>Użytkownicy</h2>
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-{{ message.category }}">{{ message.content }}</div>
        {% endfor %}
    {% endif %}
    {% if uzytkownicy %}
        <table class="table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Email</th>
                    <th>Imię</th>
                    <th>Nazwisko</th>
                    <th>Status</th>
                    <th>Akcje</th>
                </tr>
            </thead>
            <tbody>
                {% for user in uzytkownicy %}
                    <tr>
                        <td>{{ user.id_user }}</td>
                        <td>{{ user.email }}</td>
                        <td>{{ user.imie }}</td>
                        <td>{{ user.nazwisko }}</td>
                        <td>{{ user.status }}</td>
                        <td>
                            <button class="btn btn-primary open-manage-modal" data-id="{{ user.id_user }}" data-toggle="modal" data-target="#editUserModal-{{ user.id_user }}">Zarządzaj</button>
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <p>Brak użytkowników w bazie.</p>
    {% endif %}
</div>
<!-- Modal edycji użytkownika -->
{% for user in uzytkownicy %}
<div class="modal fade" id="editUserModal-{{ user.id_user }}" tabindex="-1" role="dialog" aria-labelledby="editUserModalLabel-{{ user.id_user }}" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editUserModalLabel-{{ user.id_user }}">Zarządzaj użytkownikiem: {{ user.email }}</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <form action="{{ url_for('edit_user', user_id=user.id_user) }}" method="POST" class="edit-user-form" data-user-id="{{ user.id_user }}">
                <div class="modal-body">
                    <div class="error-container"></div>
                    {{ formy[user.id_user].csrf_token }}
                    <div class="form-group">
                        <label for="email-{{ user.id_user }}">Email:</label>
                        {{ formy[user.id_user].email(class="form-control", id="email-" + user.id_user|string) }}
                        {% if formy[user.id_user].email.errors %}
                            <div class="text-danger">
                                {% for error in formy[user.id_user].email.errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label for="imie-{{ user.id_user }}">Imię:</label>
                        {{ formy[user.id_user].imie(class="form-control", id="imie-" + user.id_user|string) }}
                        {% if formy[user.id_user].imie.errors %}
                            <div class="text-danger">
                                {% for error in formy[user.id_user].imie.errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label for="nazwisko-{{ user.id_user }}">Nazwisko:</label>
                        {{ formy[user.id_user].nazwisko(class="form-control", id="nazwisko-" + user.id_user|string) }}
                        {% if formy[user.id_user].nazwisko.errors %}
                            <div class="text-danger">
                                {% for error in formy[user.id_user].nazwisko.errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                    <div class="form-group">
                        <label for="status-{{ user.id_user }}">Status:</label>
                        {{ formy[user.id_user].status(class="form-control", id="status-" + user.id_user|string) }}
                        {% if formy[user.id_user].status.errors %}
                            <div class="text-danger">
                                {% for error in formy[user.id_user].status.errors %}
                                    <p>{{ error }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Anuluj</button>
                    <button type="button" class="btn btn-danger delete-user-btn" data-user-id="{{ user.id_user }}">Usuń</button>
                    {{ formy[user.id_user].submit(class="btn btn-primary") }}
                </div>
            </form>
        </div>
    </div>
</div>
{% endfor %}

            <!-- Sekcja stolików -->
            <h2>Stoliki</h2>
            {% if stoliki %}
                <table class="tables-table">
                    <thead>
                        <tr>
                            <th>Stolik</th>
                            <th>Ilość miejsc</th>
                            <th>Akcje</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stolik in stoliki %}
                            <tr class="table-row" data-table-id="{{ stolik.id_stolika }}">
                                <td>Stolik {{ stolik.id_stolika }}</td>
                                <td>{{ stolik.ilosc_miejsc }}</td>
                                <td>
                                    <a href="#" onclick="showEditForm({{ stolik.id_stolika }}, {{ stolik.ilosc_miejsc }}); return false;" class="button">Edytuj</a>
                                    <form method="POST" action="{{ url_for('delete_table', table_id=stolik.id_stolika) }}" style="display:inline;">
                                        <button type="submit" class="button button-delete" onclick="return confirm('Czy na pewno chcesz usunąć stolik {{ stolik.id_stolika }}?')">Usuń</button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <div id="edit-form" style="display:none; margin-top: 20px;">
                    <h3>Edytuj Stolik</h3>
                    <form id="edit-table-form" method="POST" action="{{ url_for('edit_table') }}">
                        <input type="hidden" name="table_id" id="edit-table-id">
                        <label for="seats">Ilość miejsc:</label>
                        <input type="number" name="seats" id="edit-seats" min="1" required>
                        <button type="submit" class="button">Zapisz</button>
                        <button type="button" class="button button-delete" onclick="hideEditForm()">Anuluj</button>
                    </form>
                </div>

                <h3>Rezerwacje dla wybranego stolika</h3>
                <div id="table-reservations">
                    <p>Wybierz stolik, aby zobaczyć rezerwacje.</p>
                </div>
            {% else %}
                <p>Brak stolików.</p>
            {% endif %}

            <a href="{{ url_for('home') }}" class="button">Wróć</a>
        </section>

    </main>
   <script>
document.addEventListener('DOMContentLoaded', function () {
    // Obsługa otwierania modalów
    document.querySelectorAll('.open-manage-modal').forEach(button => {
        button.addEventListener('click', function () {
            const userId = this.dataset.id;
            const modal = document.getElementById(`editUserModal-${userId}`);
            if (!modal) {
                console.error(`Modal dla użytkownika ${userId} nie istnieje`);
                return;
            }
            console.log(`Otwieram modal dla użytkownika ${userId}`);
        });
    });

    // Obsługa zamykania modalów
    document.querySelectorAll('.close').forEach(closeButton => {
        closeButton.addEventListener('click', function () {
            const modal = this.closest('.modal');
            $(modal).modal('hide');
        });
    });

    // Zamykanie modal.ConcurrentUserModificationError po kliknięciu poza nim
    document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', function (e) {
            if (e.target === modal) {
                $(modal).modal('hide');
            }
        });
    });

    // Obsługa wysyłania formularzy przez AJAX
    document.querySelectorAll('.edit-user-form').forEach(form => {
        form.addEventListener('submit', function (e) {
            e.preventDefault();
            const userId = this.dataset.userId;
            const modal = document.getElementById(`editUserModal-${userId}`);
            const errorContainer = modal.querySelector('.error-container') || modal.querySelector('.modal-body');

            // Debugowanie: wartości pól formularza przed wysłaniem
            const emailField = form.querySelector(`#email-${userId}`);
            const imieField = form.querySelector(`#imie-${userId}`);
            const nazwiskoField = form.querySelector(`#nazwisko-${userId}`);
            const statusField = form.querySelector(`#status-${userId}`);
            console.log('Form values before submit:', {
                email: emailField ? emailField.value : 'Brak pola email',
                imie: imieField ? imieField.value : 'Brak pola imie',
                nazwisko: nazwiskoField ? nazwiskoField.value : 'Brak pola nazwisko',
                status: statusField ? statusField.value : 'Brak pola status'
            });

            // Debugowanie: FormData
            const formData = new FormData(this);
            for (let [key, value] of formData.entries()) {
                console.log(`FormData: ${key}: ${value}`);
            }

            // Wyczyść poprzednie błędy
            errorContainer.querySelectorAll('.alert-danger').forEach(el => el.remove());

            fetch(`/admin/edit_user/${userId}`, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                console.log('Server response:', data);
                if (data.status === 'success') {
                    $(modal).modal('hide');
                    Swal.fire({
                        icon: 'success',
                        title: 'Sukces',
                        text: data.message,
                        confirmButtonText: 'OK'
                    }).then(() => {
                        if (data.redirect) {
                            window.location.href = data.redirect;
                        } else {
                            setTimeout(() => location.reload(), 2000);
                        }
                    });
                } else {
                    let errorHtml = '';
                    if (data.errors) {
                        for (const field in data.errors) {
                            data.errors[field].forEach(error => {
                                errorHtml += `<p>${error}</p>`;
                            });
                        }
                    } else {
                        errorHtml = `<p>${data.message}</p>`;
                    }
                    const errorAlert = document.createElement('div');
                    errorAlert.className = 'alert alert-danger';
                    errorAlert.innerHTML = errorHtml;
                    errorContainer.prepend(errorAlert);
                    Swal.fire({
                        icon: 'error',
                        title: 'Błąd',
                        text: data.message || 'Błąd walidacji formularza',
                        confirmButtonText: 'OK'
                    });
                }
            })
            .catch(error => {
                console.error('Błąd:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Błąd',
                    text: `Wystąpił błąd: ${error.message}`,
                    confirmButtonText: 'OK'
                });
            });
        });
    });

    // Obsługa przycisku "Usuń"
    document.querySelectorAll('.delete-user-btn').forEach(button => {
        button.addEventListener('click', function () {
            const userId = this.dataset.userId;
            const modal = document.getElementById(`editUserModal-${userId}`);

            Swal.fire({
                title: 'Czy na pewno chcesz usunąć użytkownika?',
                text: 'Tej operacji nie można cofnąć!',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#d33',
                cancelButtonColor: '#3085d6',
                confirmButtonText: 'Tak, usuń!',
                cancelButtonText: 'Anuluj'
            }).then((result) => {
                if (result.isConfirmed) {
                    fetch(`/admin/delete_user/${userId}`, {
                        method: 'POST',
                        headers: {
                            'X-Requested-With': 'XMLHttpRequest',
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ csrf_token: document.querySelector(`#editUserModal-${userId} input[name="csrf_token"]`).value })
                    })
                    .then(response => {
                        console.log('Delete response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Delete server response:', data);
                        if (data.status === 'success') {
                            $(modal).modal('hide');
                            Swal.fire({
                                icon: 'success',
                                title: 'Sukces',
                                text: data.message,
                                confirmButtonText: 'OK'
                            }).then(() => {
                                window.location.href = data.redirect || '/admin';
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Błąd',
                                text: data.message || 'Nie udało się usunąć użytkownika.',
                                confirmButtonText: 'OK'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Błąd:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Błąd',
                            text: `Wystąpił błąd: ${error.message}`,
                            confirmButtonText: 'OK'
                        });
                    });
                }
            });
        });
    });
});
</script>
    <script src="{{ url_for('static', filename='styles/js/main.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const messages = {{ messages | tojson }};
            messages.forEach(function(message) {
                Swal.fire({
                    icon: message.category === 'success' ? 'success' : 'error',
                    title: message.category === 'success' ? 'Sukces' : 'Błąd',
                    text: message.content,
                    confirmButtonText: 'OK'
                });
            });

            // Obsługa kliknięcia w wiersz stolika
            document.querySelectorAll('.table-row').forEach(row => {
                row.addEventListener('click', function(e) {
                    // Zapobiegaj wywoływaniu zdarzenia, jeśli kliknięto link lub przycisk
                    if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') return;

                    const tableId = this.dataset.tableId;
                    fetch(`/admin/get_table_reservations/${tableId}`, {
                        method: 'GET'
                    })
                    .then(response => response.json())
                    .then(data => {
                        const reservationsDiv = document.getElementById('table-reservations');
                        if (data.status === 'success' && data.reservations.length > 0) {
                            let html = '<table class="reservations-table"><thead><tr><th>Użytkownik</th><th>Data i godzina</th><th>Status płatności</th></tr></thead><tbody>';
                            data.reservations.forEach(res => {
                                html += `<tr>
                                    <td>${res.id_user}</td>
                                    <td>${res.data}</td>
                                    <td>${res.oplacony ? 'Opłacone' : 'Nieopłacone'}</td>
                                </tr>`;
                            });
                            html += '</tbody></table>';
                            reservationsDiv.innerHTML = html;
                        } else {
                            reservationsDiv.innerHTML = '<p>Brak rezerwacji dla tego stolika.</p>';
                        }
                    })
                    .catch(error => {
                        document.getElementById('table-reservations').innerHTML = '<p>Wystąpił błąd: ' + error.message + '</p>';
                    });
                });
            });

            // Funkcje do obsługi formularza edycji
            function showEditForm(tableId, seats) {
                document.getElementById('edit-table-id').value = tableId;
                document.getElementById('edit-seats').value = seats;
                document.getElementById('edit-form').style.display = 'block';
            }

            function hideEditForm() {
                document.getElementById('edit-form').style.display = 'none';
                document.getElementById('edit-table-form').reset();
            }

            // Obsługa formularza edycji przez AJAX
            document.getElementById('edit-table-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                fetch('{{ url_for("edit_table") }}', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    Swal.fire({
                        icon: data.status === 'success' ? 'success' : 'error',
                        title: data.status === 'success' ? 'Sukces' : 'Błąd',
                        text: data.message,
                        confirmButtonText: 'OK'
                    }).then(() => {
                        if (data.status === 'success' && data.redirect) {
                            window.location.href = data.redirect;
                        }
                    });
                })
                .catch(error => {
                    Swal.fire({
                        icon: 'error',
                        title: 'Błąd',
                        text: 'Wystąpił błąd: ' + error.message,
                        confirmButtonText: 'OK'
                    });
                });
            });
        });
    </script>
</body>
</html>