<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Panel Admina</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/css/styles.css') }}">
    <link href='https://cdn.jsdelivr.net/npm/boxicons@2.0.5/css/boxicons.min.css' rel='stylesheet'>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <header class="l-header" id="header">
        <nav class="nav bd-container">
            <a href="{{ url_for('home') }}" class="nav__logo"><h1>Silver Leaf.</h1></a>
            <div class="nav__menu" id="nav-menu">
                <ul class="nav__list">
                    <li class="nav__item"><a href="{{ url_for('home') }}#home" class="nav__link">Home</a></li>
                    <li class="nav__item"><a href="{{ url_for('home') }}#about" class="nav__link">About</a></li>
                    <li class="nav__item"><a href="{{ url_for('admin') }}" class="nav__link active-link">Panel Admina</a></li>
                    <li class="nav__item"><a href="{{ url_for('logout') }}" class="nav__link">Wyloguj</a></li>
                </ul>
            </div>
            <div class="nav__toggle" id="nav-toggle">
                <i class='bx bx-menu'></i>
            </div>
        </nav>
    </header>

    <main class="l-main">
        <section class="section bd-container">
            <h1>Panel Admina</h1>
            <!-- Sekcja zarządzania użytkownikami -->
            <h2>Użytkownicy</h2>
            {% if uzytkownicy %}
                <table class="users-table">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Email</th>
                            <th>Imię</th>
                            <th>Nazwisko</th>
                            <th>Status</th>
                            <th>Akcje</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for user in uzytkownicy %}
                            <tr>
                                <td>{{ user.id_user }}</td>
                                <td>{{ user.email }}</td>
                                <td>{{ user.imie }}</td>
                                <td>{{ user.nazwisko }}</td>
                                <td>{{ user.status }}</td>
                                <td>
                                    <a href="{{ url_for('edit_user', user_id=user.id_user) }}" class="button">Edytuj</a>
                                    <form method="POST" action="{{ url_for('delete_user', user_id=user.id_user) }}" style="display:inline;">
                                        <button type="submit" class="button button-delete" onclick="return confirm('Czy na pewno chcesz usunąć użytkownika {{ user.email }}?')">Usuń</button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>Brak użytkowników w bazie.</p>
            {% endif %}

            <!-- Sekcja rezerwacji -->
            <h2>Rezerwacje</h2>
            {% if rezerwacje %}
                <table class="reservations-table">
                    <thead>
                        <tr>
                            <th>Stolik</th>
                            <th>Użytkownik</th>
                            <th>Data i godzina</th>
                            <th>Status płatności</th>
                            <th>Akcje</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for rezerwacja in rezerwacje %}
                            <tr>
                                <td>Stolik {{ rezerwacja.id_stolika }}</td>
                                <td>{{ rezerwacja.id_user }}</td>
                                <td>{{ rezerwacja.data.strftime('%Y-%m-%d %H:%M') }}</td>
                                <td>{{ 'Opłacone' if rezerwacja.oplacony else 'Nieopłacone' }}</td>
                                <td>
                                    {% if not rezerwacja.oplacony %}
                                        <a href="{{ url_for('mark_paid', rezerwacja_id=rezerwacja.id_rezerwacji) }}" class="button">Oznacz jako opłacone</a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>Brak rezerwacji.</p>
            {% endif %}

            <!-- Sekcja stolików -->
            <h2>Stoliki</h2>
            {% if stoliki %}
                <table class="tables-table">
                    <thead>
                        <tr>
                            <th>Stolik</th>
                            <th>Ilość miejsc</th>
                            <th>Akcje</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for stolik in stoliki %}
                            <tr class="table-row" data-table-id="{{ stolik.id_stolika }}">
                                <td>Stolik {{ stolik.id_stolika }}</td>
                                <td>{{ stolik.ilosc_miejsc }}</td>
                                <td>
                                    <a href="#" onclick="showEditForm({{ stolik.id_stolika }}, {{ stolik.ilosc_miejsc }}); return false;" class="button">Edytuj</a>
                                    <form method="POST" action="{{ url_for('delete_table', table_id=stolik.id_stolika) }}" style="display:inline;">
                                        <button type="submit" class="button button-delete" onclick="return confirm('Czy na pewno chcesz usunąć stolik {{ stolik.id_stolika }}?')">Usuń</button>
                                    </form>
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>

                <div id="edit-form" style="display:none; margin-top: 20px;">
                    <h3>Edytuj Stolik</h3>
                    <form id="edit-table-form" method="POST" action="{{ url_for('edit_table') }}">
                        <input type="hidden" name="table_id" id="edit-table-id">
                        <label for="seats">Ilość miejsc:</label>
                        <input type="number" name="seats" id="edit-seats" min="1" required>
                        <button type="submit" class="button">Zapisz</button>
                        <button type="button" class="button button-delete" onclick="hideEditForm()">Anuluj</button>
                    </form>
                </div>

                <h3>Rezerwacje dla wybranego stolika</h3>
                <div id="table-reservations">
                    <p>Wybierz stolik, aby zobaczyć rezerwacje.</p>
                </div>
            {% else %}
                <p>Brak stolików.</p>
            {% endif %}

            <a href="{{ url_for('home') }}" class="button">Wróć</a>
        </section>
    </main>

    <script src="{{ url_for('static', filename='styles/js/main.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const messages = {{ messages | tojson }};
            messages.forEach(function(message) {
                Swal.fire({
                    icon: message.category === 'success' ? 'success' : 'error',
                    title: message.category === 'success' ? 'Sukces' : 'Błąd',
                    text: message.content,
                    confirmButtonText: 'OK'
                });
            });

            // Obsługa kliknięcia w wiersz stolika
            document.querySelectorAll('.table-row').forEach(row => {
                row.addEventListener('click', function(e) {
                    // Zapobiegaj wywoływaniu zdarzenia, jeśli kliknięto link lub przycisk
                    if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') return;

                    const tableId = this.dataset.tableId;
                    fetch(`/admin/get_table_reservations/${tableId}`, {
                        method: 'GET'
                    })
                    .then(response => response.json())
                    .then(data => {
                        const reservationsDiv = document.getElementById('table-reservations');
                        if (data.status === 'success' && data.reservations.length > 0) {
                            let html = '<table class="reservations-table"><thead><tr><th>Użytkownik</th><th>Data i godzina</th><th>Status płatności</th></tr></thead><tbody>';
                            data.reservations.forEach(res => {
                                html += `<tr>
                                    <td>${res.id_user}</td>
                                    <td>${res.data}</td>
                                    <td>${res.oplacony ? 'Opłacone' : 'Nieopłacone'}</td>
                                </tr>`;
                            });
                            html += '</tbody></table>';
                            reservationsDiv.innerHTML = html;
                        } else {
                            reservationsDiv.innerHTML = '<p>Brak rezerwacji dla tego stolika.</p>';
                        }
                    })
                    .catch(error => {
                        document.getElementById('table-reservations').innerHTML = '<p>Wystąpił błąd: ' + error.message + '</p>';
                    });
                });
            });

            // Funkcje do obsługi formularza edycji
            function showEditForm(tableId, seats) {
                document.getElementById('edit-table-id').value = tableId;
                document.getElementById('edit-seats').value = seats;
                document.getElementById('edit-form').style.display = 'block';
            }

            function hideEditForm() {
                document.getElementById('edit-form').style.display = 'none';
                document.getElementById('edit-table-form').reset();
            }

            // Obsługa formularza edycji przez AJAX
            document.getElementById('edit-table-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                fetch('{{ url_for("edit_table") }}', {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    Swal.fire({
                        icon: data.status === 'success' ? 'success' : 'error',
                        title: data.status === 'success' ? 'Sukces' : 'Błąd',
                        text: data.message,
                        confirmButtonText: 'OK'
                    }).then(() => {
                        if (data.status === 'success' && data.redirect) {
                            window.location.href = data.redirect;
                        }
                    });
                })
                .catch(error => {
                    Swal.fire({
                        icon: 'error',
                        title: 'Błąd',
                        text: 'Wystąpił błąd: ' + error.message,
                        confirmButtonText: 'OK'
                    });
                });
            });
        });
    </script>
</body>
</html>