<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <title>Panel Admina</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/css/styles.css') }}">
    <link href='https://cdn.jsdelivr.net/npm/boxicons@2.0.5/css/boxicons.min.css' rel='stylesheet'>
    <!-- Dodaj Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Dodaj jQuery i Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.min.js"></script>
</head>
<body>
<header class="l-header" id="header">
    <nav class="nav bd-container">
        <a href="{{ url_for('home') }}" class="nav__logo"><h1>Kociołek</h1></a>
        <div class="nav__menu" id="nav-menu">
            <ul class="nav__list">
                <li class="nav__item"><a href="{{ url_for('home') }}#home" class="nav__link">Home</a></li>
                <li class="nav__item"><a href="{{ url_for('admin') }}" class="nav__link active-link">Panel Admina</a>
                </li>
                <li class="nav__item"><a href="{{ url_for('logout') }}" class="nav__link">Wyloguj</a></li>
            </ul>
        </div>
        <div class="nav__toggle" id="nav-toggle">
            <i class='bx bx-menu'></i>
        </div>
    </nav>
</header>

<main class="l-main">
    <section class="section bd-container">
        <!-- Sekcja użytkowników -->
        <div class="container">
            <h2>Użytkownicy</h2>
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.category }}">{{ message.content }}</div>
                {% endfor %}
            {% endif %}
            {% if uzytkownicy %}
                <table class="table">
                    <thead>
                    <tr>
                        <th>ID</th>
                        <th>Email</th>
                        <th>Imię</th>
                        <th>Nazwisko</th>
                        <th>Status</th>
                        <th>Akcje</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for user in uzytkownicy %}
                        <tr>
                            <td>{{ user.id_user }}</td>
                            <td>{{ user.email }}</td>
                            <td>{{ user.imie }}</td>
                            <td>{{ user.nazwisko }}</td>
                            <td>{{ user.status }}</td>
                            <td>
                                <button class="btn btn-primary open-manage-modal" data-id="{{ user.id_user }}"
                                        data-toggle="modal" data-target="#editUserModal-{{ user.id_user }}">Zarządzaj
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>Brak użytkowników w bazie.</p>
            {% endif %}
        </div>
        <!-- Modal edycji użytkownika -->
        {% for user in uzytkownicy %}
            <div class="modal fade" id="editUserModal-{{ user.id_user }}" tabindex="-1" role="dialog"
                 aria-labelledby="editUserModalLabel-{{ user.id_user }}" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editUserModalLabel-{{ user.id_user }}">Zarządzaj
                                użytkownikiem: {{ user.email }}</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">×</span>
                            </button>
                        </div>
                        <form action="{{ url_for('edit_user', user_id=user.id_user) }}" method="POST"
                              class="edit-user-form" data-user-id="{{ user.id_user }}">
                            <div class="modal-body">
                                <div class="error-container"></div>
                                {{ formy[user.id_user].csrf_token }}
                                <div class="form-group">
                                    <label for="email-{{ user.id_user }}">Email:</label>
                                    {{ formy[user.id_user].email(class="form-control", id="email-" + user.id_user|string) }}
                                    {% if formy[user.id_user].email.errors %}
                                        <div class="text-danger">
                                            {% for error in formy[user.id_user].email.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="form-group">
                                    <label for="imie-{{ user.id_user }}">Imię:</label>
                                    {{ formy[user.id_user].imie(class="form-control", id="imie-" + user.id_user|string) }}
                                    {% if formy[user.id_user].imie.errors %}
                                        <div class="text-danger">
                                            {% for error in formy[user.id_user].imie.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="form-group">
                                    <label for="nazwisko-{{ user.id_user }}">Nazwisko:</label>
                                    {{ formy[user.id_user].nazwisko(class="form-control", id="nazwisko-" + user.id_user|string) }}
                                    {% if formy[user.id_user].nazwisko.errors %}
                                        <div class="text-danger">
                                            {% for error in formy[user.id_user].nazwisko.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="form-group">
                                    <label for="status-{{ user.id_user }}">Status:</label>
                                    {{ formy[user.id_user].status(class="form-control", id="status-" + user.id_user|string) }}
                                    {% if formy[user.id_user].status.errors %}
                                        <div class="text-danger">
                                            {% for error in formy[user.id_user].status.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Anuluj</button>
                                <button type="button" class="btn btn-danger delete-user-btn"
                                        data-user-id="{{ user.id_user }}">Usuń
                                </button>
                                {{ formy[user.id_user].submit(class="btn btn-primary") }}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        {% endfor %}
        <!-- Sekcja rezerwacji -->
        <div class="container">
            <h2>Rezerwacje</h2>
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.category }}">{{ message.content }}</div>
                {% endfor %}
            {% endif %}
            {% if rezerwacje %}
                <table class="table">
                    <thead>
                    <tr>
                        <th>Email użytkownika</th>
                        <th>Data rozpoczęcia</th>
                        <th>Data zakończenia</th>
                        <th>Opłacony</th>
                        <th>Akcje</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for rezerwacja in rezerwacje %}
                        <tr class="rezerwacja-row"
                            data-id="{{ rezerwacja.id_rezerwacji }}"
                            data-end-date="{{ rezerwacja.data_konca.strftime('%Y-%m-%dT%H:%M:%S') }}"
                            data-toggle="modal"
                            data-target="#editRezerwacjaModal-{{ rezerwacja.id_rezerwacji }}"
                            style="cursor: pointer;">
                            <td>{{ rezerwacja.uzytkownik.email }}</td>
                            <td>{{ rezerwacja.data.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>{{ rezerwacja.data_konca.strftime('%Y-%m-%d %H:%M') }}</td>
                            <td>{{ 'Tak' if rezerwacja.oplacony else 'Nie' }}</td>
                            <td>
                                {% if not rezerwacja.oplacony %}
                                    <button class="btn btn-success mark-paid-btn"
                                            data-rezerwacja-id="{{ rezerwacja.id_rezerwacji }}">Oznacz jako opłacony
                                    </button>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% else %}
                <p>Brak rezerwacji w bazie.</p>
            {% endif %}
        </div>

        <!-- Modal edycji rezerwacji -->
        {% for rezerwacja in rezerwacje %}
            <div class="modal fade" id="editRezerwacjaModal-{{ rezerwacja.id_rezerwacji }}" tabindex="-1" role="dialog"
                 aria-labelledby="editRezerwacjaModalLabel-{{ rezerwacja.id_rezerwacji }}" aria-hidden="true">
                <div class="modal-dialog" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="editRezerwacjaModalLabel-{{ rezerwacja.id_rezerwacji }}">Edytuj
                                rezerwację</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">×</span>
                            </button>
                        </div>
                        <form action="{{ url_for('edit_rezerwacja', rezerwacja_id=rezerwacja.id_rezerwacji) }}"
                              method="POST" class="edit-rezerwacja-form"
                              data-rezerwacja-id="{{ rezerwacja.id_rezerwacji }}">
                            <div class="modal-body">
                                <div class="error-container"></div>
                                {{ formy_rezerwacje[rezerwacja.id_rezerwacji].csrf_token }}
                                <div class="form-group">
                                    <label for="data-{{ rezerwacja.id_rezerwacji }}">Data rozpoczęcia:</label>
                                    {{ formy_rezerwacje[rezerwacja.id_rezerwacji].data(class="form-control", id="data-" + rezerwacja.id_rezerwacji|string, value=rezerwacja.data.strftime('%Y-%m-%dT%H:%M')) }}
                                    {% if formy_rezerwacje[rezerwacja.id_rezerwacji].data.errors %}
                                        <div class="text-danger">
                                            {% for error in formy_rezerwacje[rezerwacja.id_rezerwacji].data.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="form-group">
                                    <label for="id_stolik-{{ rezerwacja.id_rezerwacji }}">Stolik:</label>
                                    {{ formy_rezerwacje[rezerwacja.id_rezerwacji].id_stolik(class="form-control", id="id_stolik-" + rezerwacja.id_rezerwacji|string) }}
                                    {% if formy_rezerwacje[rezerwacja.id_rezerwacji].id_stolik.errors %}
                                        <div class="text-danger">
                                            {% for error in formy_rezerwacje[rezerwacja.id_rezerwacji].id_stolik.errors %}
                                                <p>{{ error }}</p>
                                            {% endfor %}
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" data-dismiss="modal">Zamknij</button>
                                <button type="button" class="btn btn-danger delete-rezerwacja-btn"
                                        data-rezerwacja-id="{{ rezerwacja.id_rezerwacji }}">Usuń
                                </button>
                                {{ formy_rezerwacje[rezerwacja.id_rezerwacji].submit(class="btn btn-primary") }}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        {% endfor %}

        <!-- Sekcja stolików -->
        <div class="container">
            <h2>Stoliki</h2>
            {% if stoliki %}
                <table class="tables-table table">
                    <thead>
                    <tr>
                        <th>Stolik</th>
                        <th>Ilość miejsc</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for stolik in stoliki %}
                        <tr class="table-row" data-table-id="{{ stolik.id_stolika }}">
                            <td>Stolik {{ stolik.id_stolika }}</td>
                            <td>{{ stolik.ilosc_miejsc }}</td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% endif %}
            <!-- Modal wyświetlający rezerwacje dla stolika -->
            <div class="modal fade" id="tableReservationsModal" tabindex="-1" role="dialog"
                 aria-labelledby="tableReservationsModalLabel" aria-hidden="true">
                <div class="modal-dialog custom-modal" role="document">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="tableReservationsModalLabel">Rezerwacje dla stolika</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Zamknij">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body" id="tableReservationsModalBody">
                            <p>Ładowanie rezerwacji...</p>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal">Zamknij</button>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </section>

</main>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        console.log('JavaScript loaded for admin.html');
        const now = new Date('{{ now().strftime("%Y-%m-%dT%H:%M:%S") }}Z'); // Bieżący czas w UTC

        // Obsługa kliknięcia w wiersz
        document.querySelectorAll('.rezerwacja-row').forEach(row => {
            const endDate = new Date(row.dataset.endDate + 'Z'); // data_konca w UTC
            const isPast = endDate < now;
            if (isPast) {
                row.classList.add('past-reservation');
                row.removeAttribute('data-toggle');
                row.removeAttribute('data-target');
                row.style.cursor = 'not-allowed';
                // Ukryj przycisk "Oznacz jako opłacony" dla starych rezerwacji
                const markPaidBtn = row.querySelector('.mark-paid-btn');
                if (markPaidBtn) {
                    markPaidBtn.style.display = 'none';
                }
            }

            row.addEventListener('click', function (e) {
                console.log('Clicked row with id:', this.dataset.id, 'Classes:', this.classList);
                if (this.classList.contains('past-reservation')) {
                    console.log('Past reservation, skipping modal');
                    return;
                }
                if (e.target.classList.contains('mark-paid-btn') || e.target.closest('.mark-paid-btn')) {
                    console.log('Clicked mark-paid-btn, skipping modal');
                    return;
                }
                const rezerwacjaId = this.dataset.id;
                const modal = document.getElementById(`editRezerwacjaModal-${rezerwacjaId}`);
                if (modal) {
                    console.log('Opening modal for reservation:', rezerwacjaId);
                    $(modal).modal('show');
                } else {
                    console.error(`Modal for reservation ${rezerwacjaId} not found`);
                }
            });
        });

        // Obsługa zamykania modalów
        document.querySelectorAll('.close').forEach(closeButton => {
            closeButton.addEventListener('click', function () {
                console.log('Closing modal');
                const modal = this.closest('.modal');
                $(modal).modal('hide');
            });
        });

        // Zamykanie modalu po kliknięciu poza nim
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function (e) {
                if (e.target === modal) {
                    console.log('Clicked outside modal, closing');
                    $(modal).modal('hide');
                }
            });
        });

        // Obsługa wysyłania formularzy edycji rezerwacji przez AJAX
        document.querySelectorAll('.edit-rezerwacja-form').forEach(form => {
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                console.log('Form submit attempted for reservation:', this.dataset.rezerwacjaId);
                const rezerwacjaId = this.dataset.rezerwacjaId;
                const row = document.querySelector(`.rezerwacja-row[data-id="${rezerwacjaId}"]`);
                if (row.classList.contains('past-reservation')) {
                    console.log('Past reservation, aborting form submission');
                    Swal.fire({
                        icon: 'error',
                        title: 'Błąd',
                        text: 'Nie można edytować zakończonych rezerwacji!',
                        confirmButtonText: 'OK'
                    });
                    return;
                }
                const modal = document.getElementById(`editRezerwacjaModal-${rezerwacjaId}`);
                const errorContainer = modal.querySelector('.error-container') || modal.querySelector('.modal-body');

                // Debugowanie: wartości pól formularza
                const dataField = form.querySelector(`#data-${rezerwacjaId}`);
                const stolikField = form.querySelector(`#id_stolik-${rezerwacjaId}`);
                console.log('Form values before submit:', {
                    data: dataField ? dataField.value : 'Brak pola data',
                    id_stolik: stolikField ? stolikField.value : 'Brak pola stolik'
                });

                const formData = new FormData(this);
                for (let [key, value] of formData.entries()) {
                    console.log(`FormData: ${key}: ${value}`);
                }

                errorContainer.querySelectorAll('.alert-danger').forEach(el => el.remove());

                fetch(`/admin/edit_rezerwacja/${rezerwacjaId}`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => {
                        console.log('Response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Server response:', data);
                        if (data.status === 'success') {
                            $(modal).modal('hide');
                            Swal.fire({
                                icon: 'success',
                                title: 'Sukces',
                                text: data.message,
                                confirmButtonText: 'OK'
                            }).then(() => {
                                if (data.redirect) {
                                    window.location.href = data.redirect;
                                } else {
                                    setTimeout(() => location.reload(), 2000);
                                }
                            });
                        } else {
                            let errorHtml = '';
                            if (data.errors) {
                                for (const field in data.errors) {
                                    data.errors[field].forEach(error => {
                                        errorHtml += `<p>${error}</p>`;
                                    });
                                }
                            } else {
                                errorHtml = `<p>${data.message}</p>`;
                            }
                            const errorAlert = document.createElement('div');
                            errorAlert.className = 'alert alert-danger';
                            errorAlert.innerHTML = errorHtml;
                            errorContainer.prepend(errorAlert);
                            Swal.fire({
                                icon: 'error',
                                title: 'Błąd',
                                text: data.message || 'Błąd walidacji formularza',
                                confirmButtonText: 'OK'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Błąd:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Błąd',
                            text: `Wystąpił błąd: ${error.message}`,
                            confirmButtonText: 'OK'
                        });
                    });
            });
        });

        // Obsługa przycisku "Usuń"
        document.querySelectorAll('.delete-rezerwacja-btn').forEach(button => {
            button.addEventListener('click', function () {
                console.log('Delete button clicked for reservation:', this.dataset.rezerwacjaId);
                const rezerwacjaId = this.dataset.rezerwacjaId;
                const row = document.querySelector(`.rezerwacja-row[data-id="${rezerwacjaId}"]`);
                if (row.classList.contains('past-reservation')) {
                    console.log('Past reservation, aborting delete');
                    Swal.fire({
                        icon: 'error',
                        title: 'Błąd',
                        text: 'Nie można usunąć zakończonych rezerwacji!',
                        confirmButtonText: 'OK'
                    });
                    return;
                }
                const modal = document.getElementById(`editRezerwacjaModal-${rezerwacjaId}`);

                Swal.fire({
                    title: 'Czy na pewno chcesz usunąć rezerwację?',
                    text: 'Tej operacji nie można cofnąć!',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Tak, usuń!',
                    cancelButtonText: 'Anuluj'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/admin/delete_rezerwacja/${rezerwacjaId}`, {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({csrf_token: document.querySelector(`#editRezerwacjaModal-${rezerwacjaId} input[name="csrf_token"]`).value})
                        })
                            .then(response => {
                                console.log('Delete response status:', response.status);
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log('Delete server response:', data);
                                if (data.status === 'success') {
                                    $(modal).modal('hide');
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Sukces',
                                        text: data.message,
                                        confirmButtonText: 'OK'
                                    }).then(() => {
                                        window.location.href = data.redirect || '/admin';
                                    });
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Błąd',
                                        text: data.message || 'Nie udało się usunąć rezerwacji.',
                                        confirmButtonText: 'OK'
                                    });
                                }
                            })
                            .catch(error => {
                                console.error('Błąd:', error);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Błąd',
                                    text: `Wystąpił błąd: ${error.message}`,
                                    confirmButtonText: 'OK'
                                });
                            });
                    }
                });
            });
        });

        // Obsługa przycisku "Oznacz jako opłacony"
        document.querySelectorAll('.mark-paid-btn').forEach(button => {
            button.addEventListener('click', function (e) {
                e.stopPropagation(); // Zapobiega wyzwoleniu kliknięcia w wiersz
                console.log('Mark paid button clicked for reservation:', this.dataset.rezerwacjaId);
                const rezerwacjaId = this.dataset.rezerwacjaId;
                const row = document.querySelector(`.rezerwacja-row[data-id="${rezerwacjaId}"]`);
                if (row.classList.contains('past-reservation')) {
                    console.log('Past reservation, aborting mark paid');
                    Swal.fire({
                        icon: 'error',
                        title: 'Błąd',
                        text: 'Nie można oznaczyć zakończonych rezerwacji jako opłacone!',
                        confirmButtonText: 'OK'
                    });
                    return;
                }

                fetch(`/mark_paid/${rezerwacjaId}`, {
                    method: 'POST',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({csrf_token: document.querySelector(`#editRezerwacjaModal-${rezerwacjaId} input[name="csrf_token"]`).value})
                })
                    .then(response => {
                        console.log('Mark paid response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Mark paid server response:', data);
                        if (data.status === 'success') {
                            Swal.fire({
                                icon: 'success',
                                title: 'Sukces',
                                text: data.message,
                                confirmButtonText: 'OK'
                            }).then(() => {
                                window.location.href = data.redirect || '/admin';
                            });
                        } else {
                            Swal.fire({
                                icon: 'error',
                                title: 'Błąd',
                                text: data.message || 'Nie udało się oznaczyć rezerwacji jako opłaconej.',
                                confirmButtonText: 'OK'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Błąd:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Błąd',
                            text: `Wystąpił błąd: ${error.message}`,
                            confirmButtonText: 'OK'
                        });
                    });
            });
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Obsługa otwierania modalów
        document.querySelectorAll('.open-manage-modal').forEach(button => {
            button.addEventListener('click', function () {
                const userId = this.dataset.id;
                const modal = document.getElementById(`editUserModal-${userId}`);
                if (!modal) {
                    console.error(`Modal dla użytkownika ${userId} nie istnieje`);
                    return;
                }
                console.log(`Otwieram modal dla użytkownika ${userId}`);
            });
        });

        // Obsługa zamykania modalów
        document.querySelectorAll('.close').forEach(closeButton => {
            closeButton.addEventListener('click', function () {
                const modal = this.closest('.modal');
                $(modal).modal('hide');
            });
        });

        // Zamykanie modal.ConcurrentUserModificationError po kliknięciu poza nim
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function (e) {
                if (e.target === modal) {
                    $(modal).modal('hide');
                }
            });
        });

        // Obsługa wysyłania formularzy przez AJAX
        document.querySelectorAll('.edit-user-form').forEach(form => {
            form.addEventListener('submit', function (e) {
                e.preventDefault();
                const userId = this.dataset.userId;
                const modal = document.getElementById(`editUserModal-${userId}`);
                const errorContainer = modal.querySelector('.error-container') || modal.querySelector('.modal-body');

                // Debugowanie: wartości pól formularza przed wysłaniem
                const emailField = form.querySelector(`#email-${userId}`);
                const imieField = form.querySelector(`#imie-${userId}`);
                const nazwiskoField = form.querySelector(`#nazwisko-${userId}`);
                const statusField = form.querySelector(`#status-${userId}`);
                console.log('Form values before submit:', {
                    email: emailField ? emailField.value : 'Brak pola email',
                    imie: imieField ? imieField.value : 'Brak pola imie',
                    nazwisko: nazwiskoField ? nazwiskoField.value : 'Brak pola nazwisko',
                    status: statusField ? statusField.value : 'Brak pola status'
                });

                // Debugowanie: FormData
                const formData = new FormData(this);
                for (let [key, value] of formData.entries()) {
                    console.log(`FormData: ${key}: ${value}`);
                }

                // Wyczyść poprzednie błędy
                errorContainer.querySelectorAll('.alert-danger').forEach(el => el.remove());

                fetch(`/admin/edit_user/${userId}`, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                    .then(response => {
                        console.log('Response status:', response.status);
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        return response.json();
                    })
                    .then(data => {
                        console.log('Server response:', data);
                        if (data.status === 'success') {
                            $(modal).modal('hide');
                            Swal.fire({
                                icon: 'success',
                                title: 'Sukces',
                                text: data.message,
                                confirmButtonText: 'OK'
                            }).then(() => {
                                if (data.redirect) {
                                    window.location.href = data.redirect;
                                } else {
                                    setTimeout(() => location.reload(), 2000);
                                }
                            });
                        } else {
                            let errorHtml = '';
                            if (data.errors) {
                                for (const field in data.errors) {
                                    data.errors[field].forEach(error => {
                                        errorHtml += `<p>${error}</p>`;
                                    });
                                }
                            } else {
                                errorHtml = `<p>${data.message}</p>`;
                            }
                            const errorAlert = document.createElement('div');
                            errorAlert.className = 'alert alert-danger';
                            errorAlert.innerHTML = errorHtml;
                            errorContainer.prepend(errorAlert);
                            Swal.fire({
                                icon: 'error',
                                title: 'Błąd',
                                text: data.message || 'Błąd walidacji formularza',
                                confirmButtonText: 'OK'
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Błąd:', error);
                        Swal.fire({
                            icon: 'error',
                            title: 'Błąd',
                            text: `Wystąpił błąd: ${error.message}`,
                            confirmButtonText: 'OK'
                        });
                    });
            });
        });

        // Obsługa przycisku "Usuń"
        document.querySelectorAll('.delete-user-btn').forEach(button => {
            button.addEventListener('click', function () {
                const userId = this.dataset.userId;
                const modal = document.getElementById(`editUserModal-${userId}`);

                Swal.fire({
                    title: 'Czy na pewno chcesz usunąć użytkownika?',
                    text: 'Tej operacji nie można cofnąć!',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Tak, usuń!',
                    cancelButtonText: 'Anuluj'
                }).then((result) => {
                    if (result.isConfirmed) {
                        fetch(`/admin/delete_user/${userId}`, {
                            method: 'POST',
                            headers: {
                                'X-Requested-With': 'XMLHttpRequest',
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({csrf_token: document.querySelector(`#editUserModal-${userId} input[name="csrf_token"]`).value})
                        })
                            .then(response => {
                                console.log('Delete response status:', response.status);
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                console.log('Delete server response:', data);
                                if (data.status === 'success') {
                                    $(modal).modal('hide');
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Sukces',
                                        text: data.message,
                                        confirmButtonText: 'OK'
                                    }).then(() => {
                                        window.location.href = data.redirect || '/admin';
                                    });
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Błąd',
                                        text: data.message || 'Nie udało się usunąć użytkownika.',
                                        confirmButtonText: 'OK'
                                    });
                                }
                            })
                            .catch(error => {
                                console.error('Błąd:', error);
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Błąd',
                                    text: `Wystąpił błąd: ${error.message}`,
                                    confirmButtonText: 'OK'
                                });
                            });
                    }
                });
            });
        });
    });
</script>
<script src="{{ url_for('static', filename='styles/js/main.js') }}"></script>
<script>
    document.querySelectorAll('.table-row').forEach(row => {
        row.addEventListener('click', function (e) {
            if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') return;

            const tableId = this.dataset.tableId;
            const modalBody = document.getElementById('tableReservationsModalBody');
            const modalTitle = document.getElementById('tableReservationsModalLabel');

            modalTitle.textContent = `Rezerwacje dla stolika ${tableId}`;
            modalBody.innerHTML = '<p>Ładowanie rezerwacji...</p>';

            fetch(`/admin/get_table_reservations/${tableId}`, {
                method: 'GET'
            })
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.reservations.length > 0) {
                        let html = `
                    <table class="table table-bordered">
                        <thead>
                            <tr>
                                <th>Użytkownik</th>
                                <th>Data i godzina</th>
                                <th>Status płatności</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                        data.reservations.forEach(res => {
                            html += `
                        <tr>
                            <td>${res.email}</td>
                            <td>${res.data}</td>
                            <td>${res.oplacony ? 'Opłacone' : 'Nieopłacone'}</td>
                        </tr>
                    `;
                        });
                        html += '</tbody></table>';
                        modalBody.innerHTML = html;
                    } else {
                        modalBody.innerHTML = '<p>Brak rezerwacji dla tego stolika.</p>';
                    }
                })
                .catch(error => {
                    modalBody.innerHTML = `<p>Wystąpił błąd: ${error.message}</p>`;
                });

            $('#tableReservationsModal').modal('show');
        });
    });
</script>
</body>
</html>